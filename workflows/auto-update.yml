name: Auto Update Stata Journal Database with Citations

on:
  # æ¯å‘¨ä¸€æ—©ä¸Š8ç‚¹ UTCï¼ˆåŒ—äº¬æ—¶é—´ä¸‹åˆ4ç‚¹ï¼‰è¿è¡Œä¸€æ¬¡
  schedule:
    - cron: '0 8 * * 1'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update even if no changes'
        required: false
        default: 'false'

jobs:
  update-database:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Allow pushing changes
      issues: write    # Allow creating issues on error
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for Gitee sync
        token: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'  # Cache pip dependencies
        
    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install pandas requests beautifulsoup4 pyreadstat lxml
        pip list  # Show installed packages for debugging
        
    - name: Run update script
      id: update
      run: |
        echo "ğŸš€ å¼€å§‹ä»æœç´¢é¡µé¢çˆ¬å– Stata Journal æ•°æ®åº“..."
        echo "ğŸ“Š çˆ¬å–æ–¹å¼: ä» https://www.stata-journal.com/sjsearch.html æœç´¢é¡µé¢è·å–æ‰€æœ‰æ–‡ç« "
        echo "âœ… åŒ…æ‹¬æ‰€æœ‰æ–‡ç« ç±»å‹: st (æ­£å¼æ–‡ç« ), dm (æ•°æ®ç®¡ç†), gn (ä¹¦è¯„), gr (å›¾å½¢), pr (ç¼–ç¨‹) ç­‰"
        python auto_update.py 2>&1 | tee update_output.log
      
    - name: Check update status
      if: failure()
      run: |
        echo "âŒ æ›´æ–°è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
        exit 1
        
    - name: Parse update log
      id: parse_log
      run: |
        if [ -f update_log.json ]; then
          total=$(jq -r '.total_articles' update_log.json)
          with_doi=$(jq -r '.articles_with_doi' update_log.json)
          with_citation=$(jq -r '.articles_with_citation' update_log.json)
          year_min=$(jq -r '.year_range[0]' update_log.json)
          year_max=$(jq -r '.year_range[1]' update_log.json)
          
          echo "total_articles=$total" >> $GITHUB_OUTPUT
          echo "with_doi=$with_doi" >> $GITHUB_OUTPUT
          echo "with_citation=$with_citation" >> $GITHUB_OUTPUT
          echo "year_range=${year_min}-${year_max}" >> $GITHUB_OUTPUT
        fi
        
    - name: Check for changes
      id: changes
      run: |
        git add -A
        if git diff --staged --quiet findsj.dta findsj_version.dta; then
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "â„¹ï¸ æ•°æ®åº“æ— å˜åŒ–"
        else
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "âœ… æ•°æ®åº“å·²æ›´æ–°"
          
          # è·å–å˜æ›´ç»Ÿè®¡
          git diff --stat findsj.dta findsj_version.dta >> diff_stats.txt || true
        fi
        
    - name: Commit and push if changed
      if: steps.changes.outputs.changed == 'true' || github.event.inputs.force_update == 'true'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # Add all generated files
        git add findsj.dta findsj_version.dta update_log.json
        
        # Create detailed commit message
        commit_msg="ğŸ¤– Auto update: Stata Journal database - $(date +'%Y-%m-%d')"
        if [ -f update_log.json ]; then
          total=$(jq -r '.total_articles' update_log.json)
          commit_msg="${commit_msg}\n\nğŸ“Š Total articles: ${total}"
          commit_msg="${commit_msg}\nâœ… Update completed successfully"
        fi
        
        git commit -m "$commit_msg"
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Create detailed update summary
      if: always()
      run: |
        echo "# ğŸ“Š Stata Journal æ•°æ®åº“æ›´æ–°æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ“… æ›´æ–°ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- **æ›´æ–°æ—¶é—´**: $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **çˆ¬å–æ–¹å¼**: ä»æœç´¢é¡µé¢ç›´æ¥è·å– artidï¼Œç„¶åæŸ¥è¯¢ CrossRef API è·å–å…ƒæ•°æ®" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f update_log.json ]; then
          echo "## ğŸ“ˆ æ•°æ®ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
          total_articles=$(jq -r '.total_articles' update_log.json)
          with_doi=$(jq -r '.articles_with_doi' update_log.json)
          with_citation=$(jq -r '.articles_with_citation' update_log.json)
          year_min=$(jq -r '.year_range[0]' update_log.json)
          year_max=$(jq -r '.year_range[1]' update_log.json)
          
          echo "- **æ–‡ç« æ€»æ•°**: $total_articles" >> $GITHUB_STEP_SUMMARY
          echo "- **å«DOIæ–‡ç« **: $with_doi" >> $GITHUB_STEP_SUMMARY
          echo "- **å«å¼•æ–‡ä¿¡æ¯**: $with_citation" >> $GITHUB_STEP_SUMMARY
          echo "- **å¹´ä»½èŒƒå›´**: $year_min - $year_max" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ğŸ“° æ–‡ç« ç±»å‹åˆ†å¸ƒ" >> $GITHUB_STEP_SUMMARY
          echo "| ç±»å‹ | è¯´æ˜ | æ•°é‡ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| st | Stata Journal æ­£å¼æ–‡ç«  | â€” |" >> $GITHUB_STEP_SUMMARY
          echo "| dm | Data Management (æ•°æ®ç®¡ç†æŠ€å·§) | â€” |" >> $GITHUB_STEP_SUMMARY
          echo "| gn | Guest Notice (ä¹¦è¯„/è¯„è®º) | â€” |" >> $GITHUB_STEP_SUMMARY
          echo "| gr | Graphics (å›¾å½¢ç›¸å…³) | â€” |" >> $GITHUB_STEP_SUMMARY
          echo "| pr | Programming (ç¼–ç¨‹æŠ€å·§) | â€” |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ğŸ” å¼•ç”¨æ¬¡æ•°å‰10çš„æ–‡ç« " >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| æ–‡ç« æ ‡é¢˜ | å¹´ä»½ | å¼•ç”¨æ¬¡æ•° |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|------|---------|" >> $GITHUB_STEP_SUMMARY
          jq -r '.top_cited[] | "| \(.title[0:50])... | \(.year) | \(.cited_by_count) |"' update_log.json >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Sync to Gitee
      if: steps.changes.outputs.changed == 'true'
      continue-on-error: true
      run: |
        echo "ğŸ”„ åŒæ­¥åˆ° Gitee..."
        mkdir -p ~/.ssh
        echo "${{ secrets.GITEE_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        ssh-keyscan gitee.com >> ~/.ssh/known_hosts
        git remote add gitee git@gitee.com:ChuChengWan/findsj.git || true
        git push gitee main:main --force
        echo "âœ… å·²åŒæ­¥åˆ° Gitee"
        
    - name: Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: update-logs-${{ github.run_number }}
        path: |
          update_output.log
          update_log.json
          diff_stats.txt
        retention-days: 30
        
    - name: Create issue on failure
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const title = `âŒ æ•°æ®åº“è‡ªåŠ¨æ›´æ–°å¤±è´¥ - ${new Date().toISOString().split('T')[0]}`;
          const body = `
          ## é”™è¯¯ä¿¡æ¯
          
          æ•°æ®åº“è‡ªåŠ¨æ›´æ–°åœ¨ ${new Date().toLocaleString('zh-CN')} å¤±è´¥ã€‚
          
          **è¿è¡Œä¿¡æ¯ï¼š**
          - Workflow: ${context.workflow}
          - Run ID: ${context.runId}
          - Run Number: ${context.runNumber}
          
          **è¯·æŸ¥çœ‹ï¼š**
          - [Workflow è¿è¡Œæ—¥å¿—](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - ä¸Šä¼ çš„ Artifacts åŒ…å«è¯¦ç»†æ—¥å¿—
          
          **å¯èƒ½çš„åŸå› ï¼š**
          1. Stata Journal ç½‘ç«™ç»“æ„å˜æ›´
          2. CrossRef API è®¿é—®å¤±è´¥
          3. ç½‘ç»œè¿æ¥é—®é¢˜
          4. æ•°æ®æ ¼å¼é”™è¯¯
          
          è¯·æ‰‹åŠ¨æ£€æŸ¥å¹¶ä¿®å¤é—®é¢˜ã€‚
          `;
          
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['bug', 'auto-update']
          });

